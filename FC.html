<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Assistant</title>
    <!-- Use the Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Dark and Light theme colors */
        html[data-theme='light'] body {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        html[data-theme='dark'] body {
            background-color: #111827;
            color: #d1d5db;
        }

        .main-container {
            background-color: #ffffff;
            color: #1f2937;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark .main-container {
            background-color: #1f2937;
            color: #d1d5db;
        }

        .chat-bubble-user {
            background-color: #3b82f6;
            color: white;
            border-radius: 1.25rem 1.25rem 0.25rem 1.25rem;
        }
        .chat-bubble-ai {
            background-color: #e5e7eb;
            color: #1f2937;
            border-radius: 1.25rem 1.25rem 1.25rem 0.25rem;
        }
        .dark .chat-bubble-ai {
            background-color: #4b5563;
            color: #e5e7eb;
        }
        
        /* Input and Button Styling */
        input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #2563eb;
        }
        .dark input {
            background-color: #374151;
            color: #d1d5db;
            border-color: #4b5563;
        }

        /* Calculator section styling */
        .calc-bg {
            background-color: #f9fafb;
            transition: background-color 0.3s;
        }
        .dark .calc-bg {
            background-color: #1f2937;
        }

        /* Stat boxes */
        .stat-box-savings {
            background-color: #dcfce7;
            color: #1f2937;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark .stat-box-savings {
            background-color: #166534;
            color: #dcfce7;
        }
        .stat-box-rate {
            background-color: #e0f2fe;
            color: #1f2937;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark .stat-box-rate {
            background-color: #1d4ed8;
            color: #e0f2fe;
        }

        /* Loading animation for the chat bubble */
        @keyframes dot-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .loading-dot {
            animation: dot-pulse 1s infinite;
        }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
    </style>
</head>
<body class="flex flex-col md:flex-row min-h-screen">

    <!-- AI Chat Module -->
    <div class="main-container flex flex-col flex-grow md:w-3/4 p-6 md:p-10 shadow-2xl rounded-3xl m-4 md:m-8 h-full">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-bold text-center text-blue-700 dark:text-blue-300">Financial Assistant</h1>
            <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                <svg id="sunIcon" class="w-6 h-6 text-gray-800 hidden dark:block" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zM3 10a1 1 0 011-1h1a1 1 0 110 2H4a1 1 0 01-1-1zM17 10a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1zM10 17a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM4.93 4.93a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414L4.93 6.343a1 1 0 010-1.414zM14.12 14.12a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM14.853 5.147a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0zM5.879 14.879a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0z"></path></svg>
                <svg id="moonIcon" class="w-6 h-6 text-gray-800 dark:hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
            </button>
        </div>
        <!-- This is the chat history container that will now scroll -->
        <div id="chatHistory" class="flex-grow overflow-y-auto space-y-4 p-4 calc-bg rounded-xl mb-4 shadow-inner">
            <!-- Initial AI message -->
            <div class="flex items-start space-x-2">
                <span class="p-2 text-xl">ðŸ¤–</span>
                <div class="chat-bubble-ai p-4 max-w-xs md:max-w-md">
                    <p>Hello! I can help with a quick budget analysis or provide financial advice. What's on your mind?</p>
                </div>
            </div>
        </div>
        <div class="flex space-x-2">
            <input id="chatInput" type="text" placeholder="Ask a financial question..." class="flex-grow rounded-full p-3 pl-5 border-2 border-gray-300 focus:outline-none focus:border-blue-500 dark:border-gray-600 transition-colors">
            <select id="aiProvider" class="rounded-full p-3 border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-100 mr-2">
                <option value="gemini">Gemini</option>
                <option value="huggingface">Hugging Face</option>
            </select>
            <button id="sendButton" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full transform transition-transform duration-200 active:scale-95 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                <svg xmlns="http://www.w3.org/2d0/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path d="M3.478 2.405a.75.75 0 01.087 1.238l-1.383.896.896 1.383c.489.756 1.401.884 1.96.241L11.5 5.5l.488.316a1.5 1.5 0 001.761-2.023l-.896-1.383-1.383-.896a.75.75 0 01-.087-1.238l1.383-.896-.896-1.383a.75.75 0 01.087-1.238l1.383-.896.896-1.383a.75.75 0 011.238-.087l.896 1.383 1.383-.896a.75.75 0 01.087 1.238l-1.383.896.896 1.383a.75.75 0 01-.087 1.238l-1.383.896-.896 1.383a.75.75 0 01-1.238.087l-.896-1.383-1.383.896a.75.75 0 01-1.238-.087z" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Budget Calculator Module -->
    <div class="main-container flex flex-col md:w-1/4 p-6 md:p-10 shadow-2xl rounded-3xl m-4 md:m-8">
        <h2 class="text-3xl font-bold text-center text-blue-700 dark:text-blue-300">Quick Budget Calculator</h2>
        <div class="calc-bg rounded-xl p-6 shadow-inner flex flex-col items-center justify-center">
            
            <div class="flex flex-col md:flex-row md:space-x-4 w-full mb-6">
                <div class="w-full">
                    <label for="income" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Monthly Income ($)</label>
                    <input type="number" id="income" value="5000" min="0" step="100" class="w-full rounded-lg p-3 border-2 border-gray-300 focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                </div>
                <div class="w-full mt-4 md:mt-0">
                    <label for="expenses" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Monthly Expenses ($)</label>
                    <input type="number" id="expenses" value="3500" min="0" step="100" class="w-full rounded-lg p-3 border-2 border-gray-300 focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                </div>
            </div>

            <div class="w-full flex justify-between items-center mb-6">
                <div class="stat-box-savings p-4 rounded-xl text-center w-1/2 mr-2">
                    <p class="text-sm font-medium">Monthly Savings</p>
                    <p id="savingsAmount" class="text-2xl font-bold mt-1">$1,500</p>
                </div>
                <div class="stat-box-rate p-4 rounded-xl text-center w-1/2 ml-2">
                    <p class="text-sm font-medium">Savings Rate</p>
                    <p id="savingsRate" class="text-2xl font-bold mt-1">30%</p>
                </div>
            </div>

            <!-- Simple Visualization -->
            <div class="relative w-full h-48 flex justify-center items-center">
                <div id="chartContainer" class="w-48 h-48 relative">
                    <div id="savingsSlice" class="absolute inset-0 rounded-full transition-all duration-500 ease-out"></div>
                    <div id="expensesSlice" class="absolute inset-0 rounded-full transition-all duration-500 ease-out"></div>
                </div>
                <div class="absolute inset-0 flex flex-col justify-center items-center text-sm font-semibold text-gray-600 dark:text-gray-400 space-y-2">
                     <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-green-500 mr-2"></span> Savings</div>
                     <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-red-500 mr-2"></span> Expenses</div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for interactivity -->
    <script>
        // --- AI API Functions (from aiApis.js) ---
        const HUGGINGFACE_API_KEY = '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';
        const GEMINI_API_KEY = 'AIzaSyBbON2xPRmtqMiB326Fedfay4mbs9FXB94';

        async function sendToHuggingFace(message) {
            const response = await fetch(
                'https://api-inference.huggingface.co/models/ibm-granite/granite-3.3-2b-instruct',
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${HUGGINGFACE_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ inputs: message })
                }
            );
            return await response.json();
        }

        async function sendToGemini(message) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            const payload = {
                contents: [{ parts: [{ text: message }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "You are a friendly and knowledgeable financial assistant. Provide concise, helpful financial advice or budget analysis." }]
                },
            };
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            return await response.json();
        }

        async function sendMessageToAI(message, provider = 'huggingface') {
            if (provider === 'gemini') {
                return await sendToGemini(message);
            } else {
                return await sendToHuggingFace(message);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- Theme Toggle Functionality ---
            const themeToggleBtn = document.getElementById('themeToggle');
            const htmlElement = document.documentElement;

            themeToggleBtn.addEventListener('click', () => {
                const currentTheme = htmlElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                htmlElement.setAttribute('data-theme', newTheme);
            });

            // --- Chatbot Functionality ---
            const chatHistory = document.getElementById('chatHistory');
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            
            const addMessage = (text, sender, isTyping = false) => {
                const messageContainer = document.createElement('div');
                messageContainer.className = `flex items-start space-x-2 ${sender === 'user' ? 'justify-end' : ''}`;

                if (sender === 'ai') {
                    const iconSpan = document.createElement('span');
                    iconSpan.className = 'p-2 text-xl';
                    iconSpan.textContent = 'ðŸ¤–';
                    messageContainer.appendChild(iconSpan);
                }

                const bubble = document.createElement('div');
                bubble.className = `p-4 max-w-xs md:max-w-md ${sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`;
                
                if (isTyping) {
                     bubble.innerHTML = `
                        <div class="flex space-x-1">
                            <span class="loading-dot w-2 h-2 bg-gray-500 rounded-full"></span>
                            <span class="loading-dot w-2 h-2 bg-gray-500 rounded-full"></span>
                            <span class="loading-dot w-2 h-2 bg-gray-500 rounded-full"></span>
                        </div>
                    `;
                } else {
                    bubble.innerHTML = `<p>${text}</p>`;
                }
                
                messageContainer.appendChild(bubble);

                if (sender === 'user') {
                    const iconSpan = document.createElement('span');
                    iconSpan.className = 'p-2 text-xl';
                    iconSpan.textContent = 'ðŸ‘¤';
                    messageContainer.appendChild(iconSpan);
                }

                chatHistory.appendChild(messageContainer);
                chatHistory.scrollTop = chatHistory.scrollHeight; // Auto-scroll to the latest message
                return bubble;
            };

            const aiProvider = document.getElementById('aiProvider');

            // Use sendMessageToAI for AI API access
            async function queryAI(prompt, provider) {
                return await sendMessageToAI(prompt, provider);
            }

            const handleSendMessage = async () => {
                const message = chatInput.value.trim();
                if (message) {
                    addMessage(message, 'user');
                    chatInput.value = '';
                    sendButton.disabled = true;

                    // Read values from the budget calculator
                    const income = parseFloat(document.getElementById('income').value) || 0;
                    const expenses = parseFloat(document.getElementById('expenses').value) || 0;
                    const savings = income - expenses;
                    const savingsRate = (income > 0) ? (savings / income * 100).toFixed(1) : 0;

                    // Construct a new, data-rich prompt
                    const userQuery = `My monthly income is $${income} and my monthly expenses are $${expenses}. My monthly savings is $${savings.toFixed(2)}, which is a savings rate of ${savingsRate}%. Please provide some financial advice based on this information and my original question: "${message}"`;

                    // Add a loading message while waiting for the AI response
                    const typingBubble = addMessage('', 'ai', true);

                    try {
                        let text = "";
                        // Use the shared API function for both providers
                        const provider = aiProvider.value;
                        const result = await queryAI(userQuery, provider);
                        // Adjust this line based on your API response structure
                        text = result?.generated_text || result?.[0]?.generated_text || JSON.stringify(result);

                        typingBubble.parentElement.remove(); // Remove typing indicator
                        if (text) {
                            addMessage(text, 'ai');
                        } else {
                            addMessage("I'm sorry, I was unable to get a response from the AI. Please try again.", 'ai');
                        }

                    } catch (error) {
                        console.error('Error fetching from API:', error);
                        typingBubble.parentElement.remove(); // Remove typing indicator
                        addMessage("An error occurred while connecting to the AI. Please check your internet connection and try again.", 'ai');
                    } finally {
                        sendButton.disabled = false;
                        chatInput.focus();
                    }
                }
            };
            
            async function fetchWithExponentialBackoff(url, options, retries = 3) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (response.status === 429 && i < retries - 1) { // 429 Too Many Requests
                            const delay = Math.pow(2, i) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        return response;
                    } catch (error) {
                        if (i < retries - 1) {
                            const delay = Math.pow(2, i) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw error;
                    }
                }
            }

            sendButton.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSendMessage();
                }
            });

            // --- Budget Calculator Functionality ---
            const incomeInput = document.getElementById('income');
            const expensesInput = document.getElementById('expenses');
            const savingsAmountEl = document.getElementById('savingsAmount');
            const savingsRateEl = document.getElementById('savingsRate');
            const savingsSlice = document.getElementById('savingsSlice');
            const expensesSlice = document.getElementById('expensesSlice');

            const updateBudget = () => {
                const income = parseFloat(incomeInput.value) || 0;
                const expenses = parseFloat(expensesInput.value) || 0;

                let savings = income - expenses;
                if (savings < 0) {
                    savings = 0; // Don't show negative savings
                }

                const savingsRate = (income > 0) ? (savings / income * 100).toFixed(1) : 0;
                
                savingsAmountEl.textContent = `$${savings.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                savingsRateEl.textContent = `${savingsRate}%`;

                // Update the visual chart
                if (income > 0) {
                    const savingsPercentage = (savings / income) * 100;
                    const expensesPercentage = ((income - savings) / income) * 100;

                    savingsSlice.style.setProperty('background-image', `conic-gradient(#22c55e ${savingsPercentage}%, transparent ${savingsPercentage}%)`);
                    expensesSlice.style.setProperty('background-image', `conic-gradient(#ef4444 ${expensesPercentage}%, transparent ${expensesPercentage}%)`);
                    expensesSlice.style.setProperty('transform', `rotate(${savingsPercentage * 3.6}deg)`); // Rotate to fill the rest of the circle
                } else {
                    savingsSlice.style.setProperty('background-image', 'none');
                    expensesSlice.style.setProperty('background-image', 'none');
                }
            };

            // Listen for input changes to update the budget calculator in real-time
            incomeInput.addEventListener('input', updateBudget);
            expensesInput.addEventListener('input', updateBudget);

            // Initial calculation on page load
            updateBudget();
        });
    </script>

</body>
</html>
